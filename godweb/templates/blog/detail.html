{% extends 'base.html' %}

{% block title %}{{ post.title }} - GodWeb{% endblock %}

{% block content %}
<div class="page-header" style="padding: 40px 0;">
    <div class="container">
        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
            {% if post.category %}
            <span class="filter-tag" style="background: rgba(255,255,255,0.2); border-color: transparent; color: white;">{{ post.category.name }}</span>
            {% endif %}
            {% if post.is_premium %}
            <span class="premium-badge"><i class="fas fa-crown"></i> Premium - {{ post.premium_price }} GC</span>
            {% endif %}
            {% if post.pin_priority > 0 %}
            <span style="background: {% if post.pin_priority == 2 %}var(--danger-color){% else %}var(--primary-color){% endif %}; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px;">
                <i class="fas fa-thumbtack"></i> {% if post.pin_priority == 2 %}Admin Ghim{% else %}Đã ghim{% endif %}
            </span>
            {% endif %}

            <!-- Pin/Unpin Button -->
            {% if current_user.is_authenticated and (current_user.is_admin() or post.author_id == current_user.id) %}
                {% if not (post.pinned_by == 'admin' and not current_user.is_admin()) %}
                <form method="POST" action="{{ url_for('blog.pin_post', post_id=post.id) }}" style="margin-left: auto;">
                    <button type="submit" class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 4px 12px;">
                        <i class="fas fa-thumbtack"></i>
                        {% if post.pin_priority > 0 %}Bỏ ghim{% else %}Ghim{% endif %}
                    </button>
                </form>
                {% endif %}
            {% endif %}
        </div>
        <h1>{{ post.title }}</h1>
        <p><i class="fas fa-user"></i> {{ post.author.username }} | <i class="fas fa-calendar"></i> {{ post.created_at.strftime('%d/%m/%Y') }} | <i class="fas fa-eye"></i> {{ post.views }} lượt xem</p>
    </div>
</div>

<section class="section" style="padding-top: 40px;">
    <div class="container" style="max-width: 900px;">
        <div class="blog-content">
            {% if post.thumbnail %}
            <img src="{{ post.thumbnail|image_url }}" alt="{{ post.title }}" style="width: 100%; border-radius: 10px; margin-bottom: 30px;">
            {% endif %}

            {% if has_access %}
                <div class="post-content">
                    {{ post.content | safe }}
                </div>
            {% else %}
                <div style="position: relative;">
                    <div style="max-height: 200px; overflow: hidden; position: relative;">
                        <p>{{ post.content[:500] }}...</p>
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 100px; background: linear-gradient(transparent, white);"></div>
                    </div>

                    <div style="background: var(--light-color); border-radius: 16px; padding: 40px; text-align: center; margin-top: 20px;">
                        <i class="fas fa-lock" style="font-size: 50px; color: var(--secondary-color); margin-bottom: 20px;"></i>
                        <h3 style="margin-bottom: 15px;">Nội dung Premium</h3>
                        <p style="color: var(--text-light); margin-bottom: 20px;">Bài viết này yêu cầu <strong>{{ post.premium_price }} GodCoin</strong> để xem đầy đủ nội dung.</p>

                        {% if current_user.is_authenticated %}
                            {% if current_user.godcoin_balance >= post.premium_price %}
                            <form method="POST" action="{{ url_for('blog.purchase', post_id=post.id) }}">
                                <button type="submit" class="btn btn-secondary">
                                    <i class="fas fa-unlock"></i> Mở khóa với {{ post.premium_price }} GC
                                </button>
                            </form>
                            <p style="font-size: 14px; color: var(--text-light); margin-top: 10px;">Số dư hiện tại: {{ current_user.godcoin_balance }} GC</p>
                            {% else %}
                            <p style="color: var(--danger-color); margin-bottom: 15px;">Số dư không đủ (hiện có: {{ current_user.godcoin_balance }} GC)</p>
                            <a href="{{ url_for('wallet.topup') }}" class="btn btn-primary">
                                <i class="fas fa-coins"></i> Nạp GodCoin
                            </a>
                            {% endif %}
                        {% else %}
                            <a href="{{ url_for('auth.login') }}" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt"></i> Đăng nhập để mua
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Comments Section -->
        <div class="comments-section" style="margin-top: 40px;">
            <h3 style="margin-bottom: 20px;"><i class="fas fa-comments"></i> Bình luận ({{ comments|length }})</h3>

            {% if current_user.is_authenticated %}
            <form method="POST" action="{{ url_for('blog.add_comment', post_id=post.id) }}" style="margin-bottom: 30px;">
                <div class="form-group">
                    <textarea name="content" class="form-control" rows="3" placeholder="Viết bình luận của bạn..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Gửi bình luận
                </button>
            </form>
            {% else %}
            <div class="alert alert-info" style="margin-bottom: 30px;">
                <i class="fas fa-info-circle"></i> <a href="{{ url_for('auth.login') }}" style="color: var(--info-color);">Đăng nhập</a> để bình luận
            </div>
            {% endif %}

            {% if comments %}
                {% for comment in comments %}
                <div class="comment">
                    <div class="flex-between" style="margin-bottom: 10px;">
                        <span class="comment-author"><i class="fas fa-user-circle"></i> {{ comment.author.username }}</span>
                        <span class="comment-date">{{ comment.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                    </div>
                    <p>{{ comment.content }}</p>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state" style="padding: 30px;">
                    <i class="fas fa-comment-slash" style="font-size: 40px;"></i>
                    <p>Chưa có bình luận nào. Hãy là người đầu tiên bình luận!</p>
                </div>
            {% endif %}
        </div>

        <div style="margin-top: 30px;">
            <a href="{{ url_for('blog.index') }}" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i> Quay lại danh sách
            </a>
        </div>
    </div>
</section>
{% endblock %}
